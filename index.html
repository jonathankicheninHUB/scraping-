<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatoire Saint-André - Historique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .dashboard-header { background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 100%; }
        .chart-container { background: white; border-radius: 10px; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .table-responsive { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1rem; }
        .stat-icon { font-size: 2.5rem; color: #0d6efd; opacity: 0.2; position: absolute; right: 20px; top: 20px; }
    </style>
</head>
<body>

    <div class="dashboard-header text-center">
        <div class="container">
            <h1 class="display-5 fw-bold"><i class="fas fa-history"></i> Observatoire Saint-André</h1>
            <p class="lead">Archives Complètes : 1968 - 2023</p>
            <span class="badge bg-light text-primary">Dernière maj : <span id="last-update">...</span></span>
        </div>
    </div>

    <div class="container mb-5">
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Population 2022</h6>
                    <h2 class="fw-bold" id="kpi-pop">--</h2>
                    <i class="fas fa-users stat-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Dette / Habitant</h6>
                    <h2 class="fw-bold text-danger" id="kpi-dette">--</h2>
                    <i class="fas fa-balance-scale-right stat-icon text-danger"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Impôt Foncier</h6>
                    <h2 class="fw-bold" id="kpi-foncier">-- %</h2>
                    <i class="fas fa-home stat-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Maire Actuel</h6>
                    <h3 class="fw-bold" id="kpi-maire" style="font-size: 1.4rem;">--</h3>
                    <i class="fas fa-user-tie stat-icon"></i>
                </div>
            </div>
        </div>

        <div class="row">
             <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-3">Explosion Démographique (1968-2022)</h5>
                    <canvas id="popChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="chart-container">
                    <h5 class="mb-3">Finances : Dette vs Taxe Foncière (2013-2023)</h5>
                    <canvas id="financeChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5 class="mb-3">Archives Électorales</h5>
                    <select id="election-selector" class="form-select mb-3" onchange="updateElectionChart(this.value)">
                        <option value="2020">2020 - Victoire J. Bédier</option>
                        <option value="2014">2014 - Victoire J.P. Virapoullé</option>
                        <option value="2008">2008 - Victoire E. Fruteau</option>
                    </select>
                    <canvas id="electionChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="mb-4">Sièges (Majorité/Oppos.)</h5>
                    <canvas id="siegeChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">Chômage (2008-2023)</h5>
                    <canvas id="chomageChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">Cambriolages (2016-2023)</h5>
                    <canvas id="secuChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="table-responsive">
                    <h5 class="mb-3">Conseil Municipal Actuel</h5>
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>Nom</th><th>Fonction</th><th>Groupe</th><th>Mandat</th></tr></thead>
                        <tbody id="elus-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let allData;
        let charts = {};

        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("Erreur fichier");
                allData = await response.json();

                // KPI
                document.getElementById('last-update').innerText = allData.meta.last_update;
                document.getElementById('kpi-pop').innerText = allData.kpi.pop;
                document.getElementById('kpi-maire').innerText = allData.kpi.maire;
                document.getElementById('kpi-dette').innerText = allData.finance_current.dette_par_habitant + " €";
                document.getElementById('kpi-foncier').innerText = allData.finance_current.taux_foncier_bati + " %";

                // CHART 1: DEMOGRAPHIE (1968-2022)
                const ctxPop = document.getElementById('popChart').getContext('2d');
                new Chart(ctxPop, {
                    type: 'line',
                    data: {
                        labels: allData.history.demo.annees,
                        datasets: [{
                            label: 'Habitants',
                            data: allData.history.demo.population,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            fill: true, tension: 0.4
                        }]
                    }
                });

                // CHART 2: FINANCES (Double Axe)
                const ctxFin = document.getElementById('financeChart').getContext('2d');
                new Chart(ctxFin, {
                    type: 'line',
                    data: {
                        labels: allData.history.finance.annees,
                        datasets: [
                            {
                                label: 'Dette (€/hab)',
                                data: allData.history.finance.dette_par_hab,
                                borderColor: '#dc3545',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Taux Foncier (%)',
                                data: allData.history.finance.taux_foncier,
                                borderColor: '#198754',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: { type: 'linear', display: true, position: 'left' },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                        }
                    }
                });

                // CHART 3: CHOMAGE
                const ctxCho = document.getElementById('chomageChart').getContext('2d');
                new Chart(ctxCho, {
                    type: 'line',
                    data: {
                        labels: allData.history.chomage.annees,
                        datasets: [{
                            label: 'Taux Chômage (%)',
                            data: allData.history.chomage.taux,
                            borderColor: '#fd7e14',
                            tension: 0.3
                        }]
                    }
                });

                // CHART 4: SECU
                const ctxSec = document.getElementById('secuChart').getContext('2d');
                new Chart(ctxSec, {
                    type: 'bar',
                    data: {
                        labels: allData.history.secu.annees,
                        datasets: [{
                            label: 'Cambriolages',
                            data: allData.history.secu.cambriolages,
                            backgroundColor: '#6c757d'
                        }]
                    }
                });

                // POLITIQUE (Initialisation)
                initPolitiqueCharts();
                updateElectionChart('2020');

                // TABLEAU ELUS
                const tBody = document.getElementById('elus-table-body');
                tBody.innerHTML = "";
                allData.elus.forEach(e => {
                    tBody.innerHTML += `<tr><td class="fw-bold">${e.nom}</td><td>${e.fonction}</td><td><span class="badge bg-secondary">${e.groupe}</span></td><td>${e.mandat}</td></tr>`;
                });

            } catch (e) { console.error(e); }
        }

        function initPolitiqueCharts() {
            charts.elec = new Chart(document.getElementById('electionChart'), {
                type: 'bar', data: { labels: [], datasets: [{ data: [] }] },
                options: { indexAxis: 'y', plugins: { legend: { display: false } } }
            });
            charts.siege = new Chart(document.getElementById('siegeChart'), {
                type: 'doughnut', data: { labels: [], datasets: [{ data: [] }] }
            });
        }

        function updateElectionChart(year) {
            const d = allData.elections[year];
            // Couleurs dynamiques selon le vainqueur
            const colors = year === '2014' ? ['#0d6efd', '#dc3545'] : ['#dc3545', '#0d6efd']; // 2014 Droite, autres Gauche

            charts.elec.data.labels = d.labels;
            charts.elec.data.datasets[0].data = d.pourcentages;
            charts.elec.data.datasets[0].backgroundColor = colors;
            charts.elec.update();

            charts.siege.data.labels = d.labels;
            charts.siege.data.datasets[0].data = d.sieges;
            charts.siege.data.datasets[0].backgroundColor = colors;
            charts.siege.update();
        }

        loadDashboard();
    </script>
</body>
</html>

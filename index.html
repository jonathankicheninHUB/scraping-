<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAINT-ANDRÉ | STRATEGIC INTEL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-dark: #0f172a; --text-main: #e2e8f0; --accent: #3b82f6; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .wrapper { display: flex; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 380px; background: #1e293b; border-right: 1px solid #334155; overflow-y: auto; display: flex; flex-direction: column; }
        .brand { padding: 1.5rem; background: #0f172a; border-bottom: 1px solid #334155; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .kpi-box { background: #334155; padding: 10px; border-radius: 4px; border-left: 3px solid var(--accent); }
        .kpi-val { font-size: 1.2rem; font-weight: bold; }
        .kpi-lbl { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; }
        
        /* BENCHMARK TABLE */
        .bench-table { font-size: 0.8rem; width: 100%; color: #cbd5e1; }
        .bench-table th { text-align: left; color: #64748b; padding: 5px; }
        .bench-table td { padding: 8px 5px; border-bottom: 1px solid #334155; }
        
        /* MAP */
        .map-container { flex: 1; position: relative; }
        #map { height: 100%; width: 100%; filter: grayscale(20%) contrast(1.1); }
        
        /* FLOATING PANELS */
        .float-panel { position: absolute; top: 20px; right: 20px; width: 320px; background: rgba(30,41,59,0.95); padding: 15px; border-radius: 8px; z-index: 999; border: 1px solid #475569; backdrop-filter: blur(5px); }
        .chart-box { height: 120px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="sidebar">
        <div class="brand">
            <h5 class="m-0 fw-bold">SAINT-ANDRÉ <span class="badge bg-primary">97440</span></h5>
            <small class="text-muted">Intelligence Territoriale</small>
            <div style="font-size:0.7rem; float:right; margin-top:5px;" id="last-update">...</div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-box">
                <div class="kpi-lbl">Population</div>
                <div class="kpi-val" id="pop">--</div>
            </div>
            <div class="kpi-box" style="border-color:#ef4444;">
                <div class="kpi-lbl">Pauvreté</div>
                <div class="kpi-val text-danger" id="pauvrete">--</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-lbl">Dette/Hab</div>
                <div class="kpi-val text-warning" id="dette">--</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-lbl">Entreprises</div>
                <div class="kpi-val" id="entreprises">--</div>
            </div>
        </div>

        <div class="p-3 border-top border-secondary">
            <h6 class="text-uppercase text-primary mb-3" style="font-size:0.8rem; font-weight:bold;">
                <i class="fas fa-history"></i> Benchmark des Mandats
            </h6>
            <table class="bench-table">
                <thead><tr><th>Période</th><th>Maire</th><th>Dette Fin</th></tr></thead>
                <tbody id="bench-body"></tbody>
            </table>
        </div>

        <div class="p-3 border-top border-secondary">
            <h6 class="text-uppercase text-primary mb-2" style="font-size:0.8rem; font-weight:bold;">
                Trajectoire Démographique
            </h6>
            <canvas id="demoChart" height="100"></canvas>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>

        <div class="float-panel">
            <h6 class="text-uppercase text-light mb-3" style="font-size:0.8rem;">Diagnostic Stratégique</h6>
            
            <div class="d-flex justify-content-between mb-2">
                <span style="font-size:0.9rem;">Chômage Jeunes</span>
                <span class="fw-bold text-danger" id="chomage">--</span>
            </div>
            <div class="progress mb-3" style="height:4px; background:#334155;">
                <div class="progress-bar bg-danger" style="width:48%"></div>
            </div>

            <div class="d-flex justify-content-between mb-2">
                <span style="font-size:0.9rem;">Illettrisme (JDC)</span>
                <span class="fw-bold text-warning" id="illettrisme">--</span>
            </div>
            <div class="progress mb-3" style="height:4px; background:#334155;">
                <div class="progress-bar bg-warning" style="width:22%"></div>
            </div>

            <hr class="border-secondary">
            
            <h6 class="text-uppercase text-light mb-2" style="font-size:0.8rem;">Sécurité (2015-2023)</h6>
            <div class="chart-box">
                <canvas id="secuChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. CARTE
    const map = L.map('map', {zoomControl: false}).setView([-20.9606, 55.6495], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB', maxZoom: 19
    }).addTo(map);

    // MARQUEURS STRATEGIQUES
    const points = [
        {lat: -20.942, lng: 55.665, color: '#ef4444', label: 'Fayard (QPV)'},
        {lat: -20.950, lng: 55.635, color: '#f59e0b', label: 'Cambuston'},
        {lat: -20.9606, lng: 55.6495, color: '#3b82f6', label: 'Mairie'}
    ];
    points.forEach(p => {
        L.circleMarker([p.lat, p.lng], {
            radius: 8, fillColor: p.color, color: "#fff", weight: 2, fillOpacity: 1
        }).addTo(map).bindPopup(p.label);
    });

    // 2. DONNÉES
    async function load() {
        try {
            const r = await fetch('data.json');
            if(!r.ok) throw new Error();
            const data = await r.json();

            // KPI
            document.getElementById('last-update').innerText = data.meta.last_update;
            document.getElementById('pop').innerText = data.kpi.pop;
            document.getElementById('pauvrete').innerText = data.kpi.pauvrete;
            document.getElementById('dette').innerText = data.kpi.dette;
            document.getElementById('entreprises').innerText = data.kpi.entreprises;
            
            document.getElementById('chomage').innerText = data.diagnostic.social.chomage_jeunes;
            document.getElementById('illettrisme').innerText = data.diagnostic.social.illettrisme;

            // BENCHMARK TABLE
            const tbody = document.getElementById('bench-body');
            tbody.innerHTML = '';
            data.benchmark.forEach(b => {
                tbody.innerHTML += `
                    <tr>
                        <td><span class="badge" style="background:${b.color}">${b.periode}</span></td>
                        <td class="fw-bold text-light">${b.maire}</td>
                        <td class="text-end">${b.dette_fin}</td>
                    </tr>`;
            });

            // CHART DEMO
            new Chart(document.getElementById('demoChart'), {
                type: 'line',
                data: {
                    labels: data.history.annees_demo,
                    datasets: [{
                        label: 'Habitants',
                        data: data.history.pop,
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, maintainAspectRatio: false }
            });

            // CHART SECU
            new Chart(document.getElementById('secuChart'), {
                type: 'bar',
                data: {
                    labels: data.history.annees_secu,
                    datasets: [{
                        label: 'Faits',
                        data: data.history.faits,
                        backgroundColor: '#64748b',
                        borderRadius: 3
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, maintainAspectRatio: false }
            });

        } catch (e) { console.error(e); }
    }
    load();
</script>
</body>
</html>

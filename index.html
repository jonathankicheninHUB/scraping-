<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SAINT-ANDR√â DATA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0b1121; --card: #151e32; --text: #e2e8f0; --accent: #38bdf8; --danger: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding-bottom: 50px; }
        
        .top-bar { background: rgba(11,17,33,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #334155; padding: 1rem 2rem; position: sticky; top: 0; z-index: 999; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: 800; font-size: 1.2rem; color: white; letter-spacing: -0.5px; }
        
        .stat-card { background: var(--card); border: 1px solid #334155; border-radius: 8px; padding: 1.5rem; height: 100%; transition: transform 0.2s; }
        .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-bottom: 5px; }
        .stat-val { font-size: 2rem; font-weight: 800; color: white; line-height: 1; font-family: 'Inter'; }
        
        .nav-pills .nav-link { color: #94a3b8; background: rgba(255,255,255,0.05); margin-right: 10px; border-radius: 6px; font-weight: 600; }
        .nav-pills .nav-link.active { background: var(--accent); color: #0f172a; }
        
        .custom-table th { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .custom-table td { color: white; padding: 12px 5px; border-bottom: 1px solid #1e293b; }
        
        .chart-container { height: 250px; width: 100%; position: relative; }
        #map { height: 300px; width: 100%; border-radius: 8px; filter: grayscale(20%); border: 1px solid #334155; }
        
        .loader { text-align: center; padding: 50px; color: var(--accent); }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="brand"><i class="fas fa-database text-accent me-2"></i>SAINT-ANDR√â <span class="text-accent">INTEL</span></div>
        <div class="small font-monospace text-success"><i class="fas fa-circle me-1"></i> LIVE | <span id="last-update">...</span></div>
    </div>

    <div class="container-fluid px-4 mt-4">
        
        <div class="row g-4 mb-4">
            <div class="col-md-2"><div class="stat-card"><div class="stat-lbl">Population</div><div class="stat-val" id="kpi-pop">--</div></div></div>
            <div class="col-md-2"><div class="stat-card"><div class="stat-lbl">Maire</div><div class="stat-val h3" id="kpi-maire">--</div><small class="text-accent" id="kpi-parti">--</small></div></div>
            <div class="col-md-2"><div class="stat-card"><div class="stat-lbl">Pauvret√©</div><div class="stat-val text-danger" id="kpi-pauvrete">--</div></div></div>
            <div class="col-md-2"><div class="stat-card"><div class="stat-lbl">Dette/Hab</div><div class="stat-val text-warning" id="kpi-dette">--</div></div></div>
            <div class="col-md-2"><div class="stat-card"><div class="stat-lbl">Entreprises</div><div class="stat-val h4" id="kpi-eco">--</div></div></div>
            <div class="col-md-2"><div class="stat-card"><div class="stat-lbl">S√©curit√©</div><div class="stat-val h4 text-danger">Alerte</div></div></div>
        </div>

        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-pol">üèõÔ∏è POLITIQUE</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-soc">‚ù§Ô∏è SOCIAL</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-his">üìà HISTOIRE</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="tab-pol">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="stat-card mb-4">
                            <h5 class="text-white mb-3">Guerre des Blocs (1983 - 2020)</h5>
                            <div class="chart-container"><canvas id="macroChart"></canvas></div>
                        </div>
                        <div class="stat-card">
                            <h5 class="text-white mb-3">Benchmark des Mandats</h5>
                            <table class="custom-table w-100">
                                <thead><tr><th>P√©riode</th><th>Maire</th><th>Parti</th><th>Dette Fin</th><th>Style</th></tr></thead>
                                <tbody id="bench-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="stat-card h-100">
                            <h5 class="text-white mb-3">Zoom √âlections</h5>
                            <select class="form-select bg-dark text-white border-secondary mb-3" onchange="updateElec(this.value)">
                                <option value="2020">2020 (Victoire B√©dier)</option>
                                <option value="2014">2014 (Victoire Virapoull√©)</option>
                                <option value="2008">2008 (Victoire Fruteau)</option>
                            </select>
                            <div class="chart-container" style="height:220px"><canvas id="elecChart"></canvas></div>
                            <div class="mt-3 p-3 border border-secondary rounded bg-dark text-muted small" id="elec-analyse">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-soc">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="stat-card h-100">
                            <h5 class="text-white mb-4">Pr√©carit√©</h5>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1 small text-muted"><span>Ch√¥mage Jeunes</span><span class="text-danger fw-bold" id="soc-chomage">--</span></div>
                                <div class="progress" style="height:6px; background:#1e293b"><div class="progress-bar bg-danger" style="width:48%"></div></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1 small text-muted"><span>Illettrisme</span><span class="text-warning fw-bold" id="soc-illettrisme">--</span></div>
                                <div class="progress" style="height:6px; background:#1e293b"><div class="progress-bar bg-warning" style="width:22%"></div></div>
                            </div>
                            <div class="row mt-4 text-center">
                                <div class="col-6 border-end border-secondary">
                                    <div class="h4 text-white mb-0" id="soc-caf">--</div><small class="text-muted">Alloc. CAF</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 text-danger mb-0" id="soc-rsa">--</div><small class="text-muted">RSA</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="stat-card mb-4">
                            <h5 class="text-white mb-3">Cartographie (Leaflet)</h5>
                            <div id="map"></div>
                        </div>
                        <div class="stat-card">
                            <h5 class="text-white mb-3">S√©curit√© (Faits Constat√©s)</h5>
                            <div class="chart-container" style="height:200px"><canvas id="secuChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-his">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="stat-card">
                            <h5 class="text-white mb-3">D√©mographie (1968-2022)</h5>
                            <div class="chart-container"><canvas id="demoChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="stat-card">
                            <h5 class="text-white mb-3">Dette Publique</h5>
                            <div class="chart-container"><canvas id="detteChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        Chart.defaults.color = '#64748b';
        Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.1)';
        
        let globalData, elecChart;

        async function init() {
            try {
                const r = await fetch('data.json');
                if(!r.ok) throw new Error();
                globalData = await r.json();

                // KPI
                document.getElementById('last-update').innerText = globalData.meta.last_update;
                document.getElementById('kpi-pop').innerText = globalData.kpi.pop;
                document.getElementById('kpi-maire').innerText = globalData.kpi.maire;
                document.getElementById('kpi-parti').innerText = globalData.kpi.parti;
                document.getElementById('kpi-pauvrete').innerText = globalData.kpi.pauvrete;
                document.getElementById('kpi-dette').innerText = globalData.kpi.dette;
                document.getElementById('kpi-eco').innerText = globalData.kpi.entreprises;

                // SOCIAL
                document.getElementById('soc-chomage').innerText = globalData.social.chomage;
                document.getElementById('soc-illettrisme').innerText = globalData.social.illettrisme;
                document.getElementById('soc-caf').innerText = globalData.social.caf;
                document.getElementById('soc-rsa').innerText = globalData.social.rsa;

                // BENCHMARK
                const tb = document.getElementById('bench-body');
                tb.innerHTML = '';
                globalData.benchmark.forEach(b => {
                    tb.innerHTML += `<tr><td class="text-white fw-bold">${b.periode}</td><td style="color:${b.color}">${b.maire}</td><td>${b.parti}</td><td>${b.dette}</td><td class="text-muted small">${b.style}</td></tr>`;
                });

                // CHARTS
                new Chart(document.getElementById('macroChart'), {
                    type: 'line',
                    data: {
                        labels: globalData.charts.politique_macro.annees,
                        datasets: [
                            { label: 'Droite', data: globalData.charts.politique_macro.droite, borderColor: '#3b82f6', tension:0.4 },
                            { label: 'Gauche', data: globalData.charts.politique_macro.gauche, borderColor: '#ef4444', tension:0.4 }
                        ]
                    },
                    options: { maintainAspectRatio: false }
                });

                new Chart(document.getElementById('secuChart'), { type: 'bar', data: { labels: globalData.charts.securite.annees, datasets: [{ label: 'Faits', data: globalData.charts.securite.data, backgroundColor: '#334155' }] }, options: { maintainAspectRatio: false } });
                new Chart(document.getElementById('demoChart'), { type: 'line', data: { labels: globalData.charts.demographie.annees, datasets: [{ label: 'Pop', data: globalData.charts.demographie.data, borderColor: '#38bdf8', borderWidth: 3 }] }, options: { maintainAspectRatio: false } });
                new Chart(document.getElementById('detteChart'), { type: 'bar', data: { labels: globalData.charts.dette.annees, datasets: [{ label: 'Dette', data: globalData.charts.dette.data, backgroundColor: '#f59e0b' }] }, options: { maintainAspectRatio: false } });

                // ELEC DETAIL
                const ctxE = document.getElementById('elecChart');
                elecChart = new Chart(ctxE, { type: 'doughnut', data: { labels:[], datasets:[{data:[]}] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{color:'white'} } } } });
                updateElec('2020');

                // MAP
                const map = L.map('map', {zoomControl: false}).setView([-20.9606, 55.6495], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '¬© CartoDB'}).addTo(map);
                L.circleMarker([-20.942, 55.665], {color: '#ef4444', radius: 8}).addTo(map).bindPopup("Fayard");
                L.circleMarker([-20.9606, 55.6495], {color: '#3b82f6', radius: 6}).addTo(map).bindPopup("Mairie");

            } catch (e) { console.error(e); }
        }

        function updateElec(year) {
            const d = globalData.charts.elections[year];
            elecChart.data.labels = d.labels;
            elecChart.data.datasets[0].data = d.data;
            elecChart.data.datasets[0].backgroundColor = d.colors;
            elecChart.data.datasets[0].borderWidth = 0;
            elecChart.update();
            document.getElementById('elec-analyse').innerHTML = "<strong>ANALYSE :</strong> " + d.analyse;
        }

        init();
    </script>
</body>
</html>

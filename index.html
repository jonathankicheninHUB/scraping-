<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAINT-ANDR√â | DATA AUDIT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a; --panel-bg: #1e293b; --border: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --accent: #38bdf8; --danger: #ef4444; --warning: #f59e0b;
            --success: #10b981;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 50px; }
        
        .navbar { background: rgba(15,23,42,0.95); border-bottom: 1px solid var(--border); padding: 1rem 2rem; }
        .badge-live { font-family: 'JetBrains Mono'; font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; }
        .badge-ok { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
        
        /* KPI AVEC SOURCE */
        .kpi-card {
            background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 1.2rem;
            height: 100%; position: relative; display: flex; flex-direction: column; justify-content: space-between;
        }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: white; margin-bottom: 5px; }
        .kpi-source { font-size: 0.65rem; color: #64748b; font-family: 'Inter'; border-top: 1px solid #334155; padding-top: 8px; margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        
        /* TABS */
        .nav-pills .nav-link { color: var(--text-muted); background: rgba(255,255,255,0.05); margin-right: 10px; font-size: 0.85rem; }
        .nav-pills .nav-link.active { background: var(--accent); color: #0f172a; font-weight: bold; }
        
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; }
        #map { height: 320px; width: 100%; border-radius: 8px; filter: grayscale(20%); border: 1px solid var(--border); }
        
        .table-dark-custom th { color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid #475569; }
        .table-dark-custom td { color: white; border-bottom: 1px solid #334155; padding: 10px 5px; vertical-align: middle; font-size: 0.85rem; }
    </style>
</head>
<body>

    <nav class="navbar sticky-top">
        <div class="d-flex align-items-center gap-3">
            <span class="fw-bold"><i class="fas fa-check-circle text-success me-2"></i>SAINT-ANDR√â <span class="text-muted">V3.0</span></span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="text-muted small" id="last-update">...</span>
            <span class="badge-live badge-ok">‚óè SYST√àME AUDIT√â</span>
        </div>
    </nav>

    <div class="container-fluid px-4 mt-4">
        
        <div class="row g-3 mb-4">
            <div class="col-md-2">
                <div class="kpi-card" style="border-left: 3px solid var(--accent);">
                    <div>
                        <div class="kpi-label">Population</div>
                        <div class="kpi-value" id="kpi-pop">--</div>
                    </div>
                    <div class="kpi-source"><i class="fas fa-database"></i> <span id="src-pop">--</span></div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card" style="border-left: 3px solid var(--danger);">
                    <div>
                        <div class="kpi-label">Pauvret√©</div>
                        <div class="kpi-value text-danger" id="kpi-pauv">--</div>
                    </div>
                    <div class="kpi-source"><i class="fas fa-file-alt"></i> <span id="src-pauv">--</span></div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card" style="border-left: 3px solid var(--warning);">
                    <div>
                        <div class="kpi-label">Dette / Hab</div>
                        <div class="kpi-value text-warning" id="kpi-dette">--</div>
                    </div>
                    <div class="kpi-source"><i class="fas fa-coins"></i> <span id="src-dette">--</span></div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card" style="border-left: 3px solid #e11d48;">
                    <div>
                        <div class="kpi-label">Maire</div>
                        <div class="kpi-value h4 mb-0" id="kpi-maire">--</div>
                        <div class="small text-danger">DVG (Gauche)</div>
                    </div>
                    <div class="kpi-source"><i class="fas fa-vote-yea"></i> <span id="src-maire">--</span></div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card" style="border-left: 3px solid var(--success);">
                    <div>
                        <div class="kpi-label">Entreprises</div>
                        <div class="kpi-value h4 mb-0" id="kpi-eco">--</div>
                    </div>
                    <div class="kpi-source"><i class="fas fa-plug"></i> <span id="src-eco">--</span></div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card" style="border-left: 3px solid #64748b;">
                    <div>
                        <div class="kpi-label">S√©curit√©</div>
                        <div class="kpi-value h4 mb-0 text-muted" id="kpi-secu">--</div>
                    </div>
                    <div class="kpi-source"><i class="fas fa-shield-alt"></i> <span id="src-secu">--</span></div>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-pol">üèõÔ∏è POLITIQUE</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-soc">‚ù§Ô∏è SOCIAL</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-hist">üìà FINANCES & HISTOIRE</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-pol">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="kpi-card mb-4">
                            <h5 class="text-white mb-3 text-uppercase fs-6">Guerre des Blocs (1983-2020)</h5>
                            <div class="chart-container"><canvas id="macroChart"></canvas></div>
                            <small class="text-muted mt-2 text-end d-block">Source : Archives Minist√®re Int√©rieur</small>
                        </div>
                        <div class="kpi-card">
                            <h5 class="text-white mb-3 text-uppercase fs-6">Benchmark Mandats</h5>
                            <table class="table table-dark-custom mb-0">
                                <thead><tr><th>P√©riode</th><th>Maire</th><th>Parti</th><th>Dette Fin</th><th>Style</th></tr></thead>
                                <tbody id="bench-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="kpi-card h-100">
                            <h5 class="text-white mb-3 text-uppercase fs-6">D√©tail Scrutins</h5>
                            <select class="form-select bg-dark text-white border-secondary mb-3" onchange="updateElec(this.value)">
                                <option value="2020">Municipales 2020</option>
                                <option value="2014">Municipales 2014</option>
                                <option value="2008">Municipales 2008</option>
                            </select>
                            <div class="chart-container" style="height:200px"><canvas id="elecChart"></canvas></div>
                            <div class="mt-3 small text-muted border-top border-secondary pt-3" id="elec-analyse">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-soc">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="kpi-card h-100">
                            <h5 class="text-white mb-4 text-uppercase fs-6">Pr√©carit√© & √âducation</h5>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1 small text-muted"><span>Ch√¥mage Jeunes (15-24)</span> <span class="text-danger fw-bold" id="soc-chom">--</span></div>
                                <div class="progress" style="height:6px; background:#1e293b"><div class="progress-bar bg-danger" style="width:48%"></div></div>
                                <small class="text-muted" style="font-size:0.6rem">Source: P√¥le Emploi</small>
                            </div>
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1 small text-muted"><span>Illettrisme (JDC)</span> <span class="text-warning fw-bold" id="soc-ill">--</span></div>
                                <div class="progress" style="height:6px; background:#1e293b"><div class="progress-bar bg-warning" style="width:22.5%"></div></div>
                                <small class="text-muted" style="font-size:0.6rem">Source: JDC 2022</small>
                            </div>
                            <div class="d-flex justify-content-between border-top border-secondary pt-3 mt-4">
                                <div><div class="h4 text-white mb-0" id="soc-caf">--</div><small class="text-muted">Alloc. CAF</small></div>
                                <div><div class="h4 text-danger mb-0" id="soc-rsa">--</div><small class="text-muted">RSA</small></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="kpi-card mb-4">
                            <h5 class="text-white mb-3 text-uppercase fs-6">Zones Prioritaires (QPV)</h5>
                            <div id="map"></div>
                        </div>
                        <div class="kpi-card">
                            <h5 class="text-white mb-3 text-uppercase fs-6">S√©curit√© (Faits Constat√©s)</h5>
                            <div class="chart-container" style="height:200px"><canvas id="secuChart"></canvas></div>
                            <small class="text-muted mt-2 text-end d-block">Source : SSMSI (Base Communale)</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-hist">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="kpi-card">
                            <h5 class="text-white mb-3 text-uppercase fs-6">D√©mographie (1968-2022)</h5>
                            <div class="chart-container"><canvas id="demoChart"></canvas></div>
                            <small class="text-muted mt-2 text-end d-block">Source : INSEE RGP</small>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="kpi-card">
                            <h5 class="text-white mb-3 text-uppercase fs-6">Dette Publique</h5>
                            <div class="chart-container"><canvas id="detteChart"></canvas></div>
                            <small class="text-muted mt-2 text-end d-block">Source : DGFiP</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155'; Chart.defaults.font.family = "'Inter'";
        let globalData, elecChart;

        async function init() {
            try {
                const r = await fetch('data.json');
                if(!r.ok) throw new Error();
                globalData = await r.json();

                // KPI SOURC√âS
                document.getElementById('last-update').innerText = globalData.meta.last_update;
                
                const setKpi = (id, key) => {
                    const obj = globalData.kpi[key];
                    document.getElementById(`kpi-${id}`).innerText = obj.valeur;
                    document.getElementById(`src-${id}`).innerText = obj.source;
                };
                
                setKpi('pop', 'pop');
                setKpi('pauv', 'pauvrete');
                setKpi('dette', 'dette');
                setKpi('maire', 'maire');
                setKpi('eco', 'entreprises');
                setKpi('secu', 'securite');

                // SOCIAL
                const soc = globalData.social.indicateurs;
                document.getElementById('soc-chom').innerText = soc.chomage.val;
                document.getElementById('soc-ill').innerText = soc.illettrisme.val;
                document.getElementById('soc-caf').innerText = soc.caf.val;
                document.getElementById('soc-rsa').innerText = soc.rsa.val;

                // BENCHMARK
                const tb = document.getElementById('bench-body'); tb.innerHTML = '';
                globalData.politique.benchmark_maires.forEach(b => {
                    tb.innerHTML += `<tr><td class="text-white fw-bold">${b.periode}</td><td style="color:${b.color}">${b.nom}</td><td><span class="badge" style="background:${b.color}20; color:${b.color}; border:1px solid ${b.color}">${b.parti}</span></td><td class="text-warning font-monospace">${b.dette_fin}</td><td class="text-muted small">${b.style}</td></tr>`;
                });

                // CHART MACRO
                new Chart(document.getElementById('macroChart'), {
                    type: 'line',
                    data: {
                        labels: globalData.politique.macro_tendances.annees,
                        datasets: [
                            {label:'Droite', data:globalData.politique.macro_tendances.bloc_droite, borderColor:'#3b82f6', tension:0.4, borderWidth:3},
                            {label:'Gauche', data:globalData.politique.macro_tendances.bloc_gauche, borderColor:'#e11d48', tension:0.4, borderWidth:3}
                        ]
                    }, options: {maintainAspectRatio:false, scales:{y:{min:30}}}
                });

                // SECU
                new Chart(document.getElementById('secuChart'), {
                    type: 'bar',
                    data: {
                        labels: globalData.regalien.securite_trend.annees,
                        datasets: [{label:'Faits', data:globalData.regalien.securite_trend.faits, backgroundColor:'#475569', borderRadius:4}]
                    }, options: {maintainAspectRatio:false, scales:{y:{beginAtZero:false}}}
                });

                // DEMO
                new Chart(document.getElementById('demoChart'), {
                    type: 'line',
                    data: {
                        labels: globalData.social.demographie_historique.annees,
                        datasets: [{label:'Population', data:globalData.social.demographie_historique.population, borderColor:'#38bdf8', borderWidth:3}]
                    }, options: {maintainAspectRatio:false}
                });

                // DETTE
                new Chart(document.getElementById('detteChart'), {
                    type: 'bar',
                    data: {
                        labels: globalData.regalien.finances_trend.annees,
                        datasets: [{label:'Dette', data:globalData.regalien.finances_trend.dette, backgroundColor:'#f59e0b', borderRadius:4}]
                    }, options: {maintainAspectRatio:false}
                });

                // ELEC
                const ctxE = document.getElementById('elecChart');
                elecChart = new Chart(ctxE, { type: 'doughnut', data: { labels:[], datasets:[{data:[]}] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right', labels:{color:'white'} } }, cutout: '70%' } });
                updateElec('2020');

                // MAP
                const map = L.map('map', {zoomControl: false}).setView([-20.9606, 55.6495], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '¬© CartoDB'}).addTo(map);
                L.circleMarker([-20.942, 55.665], {color: '#ef4444', radius: 8}).addTo(map).bindPopup("<b>Fayard</b><br>QPV");
                L.circleMarker([-20.950, 55.635], {color: '#f59e0b', radius: 8}).addTo(map).bindPopup("<b>Cambuston</b>");

            } catch (e) { console.error(e); }
        }

        function updateElec(year) {
            const d = globalData.politique.details_scrutins[year];
            elecChart.data.labels = d.candidats;
            elecChart.data.datasets[0].data = d.scores;
            elecChart.data.datasets[0].backgroundColor = d.couleurs;
            elecChart.data.datasets[0].borderWidth = 0;
            elecChart.update();
            document.getElementById('elec-analyse').innerHTML = d.analyse;
        }

        init();
    </script>
</body>
</html>

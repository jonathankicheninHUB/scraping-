<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatoire Saint-André (97440)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --bg-color: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard-header { background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: var(--card-shadow); border: none; height: 100%; transition: transform 0.2s; }
        .stat-icon { font-size: 2.5rem; color: var(--primary-color); opacity: 0.2; position: absolute; right: 20px; top: 20px; }
        .chart-container { background: white; border-radius: 10px; padding: 1rem; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; }
        .table-responsive { background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 1rem; }
        .badge-pol { font-size: 0.8em; padding: 0.4em 0.8em; }
    </style>
</head>
<body>

    <div class="dashboard-header text-center">
        <div class="container">
            <h1 class="display-5 fw-bold"><i class="fas fa-chart-line"></i> Observatoire Saint-André</h1>
            <p class="lead">Données officielles : Démographie, Économie et Élections (97440)</p>
            <span class="badge bg-light text-primary">Mise à jour : <span id="last-update">Chargement...</span></span>
        </div>
    </div>

    <div class="container mb-5">
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Population (INSEE)</h6>
                    <h2 class="fw-bold" id="kpi-pop">--</h2>
                    <p class="text-success small mb-0"><i class="fas fa-check-circle"></i> Officiel État</p>
                    <i class="fas fa-users stat-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Entreprises Actives</h6>
                    <h2 class="fw-bold" id="kpi-entreprises">--</h2>
                    <p class="text-primary small mb-0">API Sirene</p>
                    <i class="fas fa-building stat-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Participation (2020)</h6>
                    <h2 class="fw-bold" id="kpi-participation">--%</h2>
                    <p class="text-muted small mb-0">Municipales 2nd Tour</p>
                    <i class="fas fa-vote-yea stat-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card position-relative">
                    <h6 class="text-muted text-uppercase">Maire Actuel</h6>
                    <h3 class="fw-bold" id="kpi-maire" style="font-size: 1.5rem;">--</h3>
                    <p class="text-success small mb-0">Majorité</p>
                    <i class="fas fa-user-tie stat-icon"></i>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="chart-container">
                    <h5 class="mb-4" id="election-title">Résultats Élections (Chargement...)</h5>
                    <canvas id="electionChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="mb-4">Répartition Conseil Municipal</h5>
                    <canvas id="siegeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-4">Évolution Délinquance (Est. ONDRP)</h5>
                    <canvas id="secuChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-4">Taux de Chômage (Tendance INSEE)</h5>
                    <canvas id="socioChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <h5 class="mb-3">Vos Élus Locaux</h5>
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nom</th>
                                <th>Fonction</th>
                                <th>Groupe & Étiquette</th>
                                <th>Mandat</th>
                            </tr>
                        </thead>
                        <tbody id="elus-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 text-muted small">
        <p>&copy; 2025 Observatoire Saint-André. Données publiques agrégées via GitHub Actions.</p>
        <p>Sources : API Géo, API Recherche Entreprises, Ministère de l'Intérieur.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error("Fichier data.json introuvable");
                
                const data = await response.json();

                // 2. REMPLISSAGE DES KPI
                document.getElementById('last-update').innerText = data.meta.last_update;
                document.getElementById('kpi-pop').innerText = data.kpi.pop;
                document.getElementById('kpi-entreprises').innerText = data.kpi.entreprises;
                document.getElementById('kpi-participation').innerText = data.kpi.participation + '%';
                document.getElementById('kpi-maire').innerText = data.kpi.maire;

                // 3. GRAPHIQUES
                document.getElementById('election-title').innerText = `Résultats ${data.elections.titre}`;

                new Chart(document.getElementById('electionChart'), {
                    type: 'bar',
                    data: {
                        labels: data.elections.labels,
                        datasets: [{
                            label: '% des Voix',
                            data: data.elections.votes,
                            backgroundColor: ['#dc3545', '#0d6efd'], 
                            borderRadius: 5
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });

                new Chart(document.getElementById('siegeChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.elections.labels,
                        datasets: [{
                            data: data.elections.sieges,
                            backgroundColor: ['#dc3545', '#0d6efd']
                        }]
                    }
                });

                new Chart(document.getElementById('secuChart'), {
                    type: 'line',
                    data: {
                        labels: data.socio_eco.annees,
                        datasets: [{
                            label: 'Cambriolages (Est.)',
                            data: data.socio_eco.cambriolages,
                            borderColor: '#fd7e14',
                            tension: 0.3
                        }]
                    },
                    options: { responsive: true }
                });

                new Chart(document.getElementById('socioChart'), {
                    type: 'line',
                    data: {
                        labels: data.socio_eco.annees,
                        datasets: [{
                            label: 'Taux Chômage (%)',
                            data: data.socio_eco.chomage,
                            borderColor: '#20c997',
                            backgroundColor: 'rgba(32, 201, 151, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    }
                });

                // 4. TABLEAU DES ÉLUS
                const tableBody = document.getElementById('elus-table-body');
                tableBody.innerHTML = ""; 
                data.elus.forEach(elu => {
                    const row = `
                        <tr>
                            <td class="fw-bold">${elu.nom}</td>
                            <td>${elu.fonction}</td>
                            <td><span class="badge ${elu.groupe.includes('Majorité') ? 'bg-success' : 'bg-secondary'} badge-pol">${elu.groupe}</span></td>
                            <td>${elu.mandat}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

            } catch (error) {
                console.error("Erreur de chargement des données:", error);
                document.getElementById('last-update').innerText = "ERREUR (vérifier data.json)";
            }
        }

        // Lancement
        loadDashboard();
    </script>
</body>
</html>

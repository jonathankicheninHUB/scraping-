<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAINT-ANDR√â | WAR ROOM</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            /* COULEURS S√âMANTIQUES */
            --info: #38bdf8;      /* Bleu Cyan (Neutre/Info) */
            --danger: #ef4444;    /* Rouge (Pauvret√©/Alerte) */
            --warning: #f59e0b;   /* Orange (Dette/Attention) */
            --success: #10b981;   /* Vert (Positif) */
            --politics-l: #e11d48; /* Rouge Gauche */
            --politics-r: #2563eb; /* Bleu Droite */
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            padding-bottom: 50px;
        }

        /* HEADER */
        .navbar {
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid #334155;
            backdrop-filter: blur(10px);
        }
        .navbar-brand { font-weight: 800; letter-spacing: -0.5px; color: white !important; }
        .badge-live { 
            font-family: 'JetBrains Mono'; font-size: 0.7rem; 
            background: rgba(56, 189, 248, 0.1); color: var(--info); 
            border: 1px solid var(--info); padding: 4px 8px; border-radius: 4px;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
        }

        /* KPI CARDS */
        .kpi-card {
            background: var(--panel-bg);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1.5rem;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        /* Bordure color√©e √† gauche selon le contexte */
        .kpi-card.neutral { border-left: 4px solid var(--info); }
        .kpi-card.alert { border-left: 4px solid var(--danger); }
        .kpi-card.warn { border-left: 4px solid var(--warning); }
        .kpi-card.pol { border-left: 4px solid var(--politics-l); } /* Par d√©faut maire actuel */

        .kpi-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 5px; letter-spacing: 1px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; line-height: 1; color: white; }
        .kpi-sub { font-size: 0.8rem; margin-top: 5px; opacity: 0.8; font-family: 'JetBrains Mono'; }

        /* CHARTS & TABS */
        .chart-container { position: relative; height: 280px; width: 100%; margin-top:15px; }
        #map { height: 350px; width: 100%; border-radius: 8px; filter: grayscale(20%) contrast(1.1); border: 1px solid #334155; }

        .nav-pills .nav-link { 
            color: var(--text-muted); 
            font-weight: 600; 
            background: rgba(255,255,255,0.05); 
            margin-right: 10px; 
            border: 1px solid transparent;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .nav-pills .nav-link.active { 
            background: var(--info); 
            color: #0f172a; 
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }

        /* TABLES */
        .table-dark-custom { --bs-table-bg: transparent; color: var(--text-muted); font-size: 0.9rem; }
        .table-dark-custom th { border-bottom: 2px solid #334155; color: white; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .table-dark-custom td { border-bottom: 1px solid #334155; padding: 15px 10px; vertical-align: middle; }
        
        .badge-style { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
    </style>
</head>
<body>

    <nav class="navbar fixed-top">
        <div class="container-fluid px-4">
            <span class="navbar-brand"><i class="fas fa-terminal text-info me-2"></i>SAINT-ANDR√â <span class="text-info">DATA</span></span>
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted small" id="last-update">Sync...</span>
                <span class="badge-live">‚óè SYST√àME EN LIGNE</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4" style="margin-top: 80px;">
        
        <div class="row g-4 mb-4">
            <div class="col-md-2">
                <div class="kpi-card neutral">
                    <div class="kpi-label">Population</div>
                    <div class="kpi-value" id="kpi-pop">--</div>
                    <div class="kpi-sub text-info"><i class="fas fa-arrow-up"></i> Croissance</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card pol">
                    <div class="kpi-label">Maire Actuel</div>
                    <div class="kpi-value h4 mb-0" id="kpi-maire">--</div>
                    <div class="kpi-sub" style="color:var(--politics-l);" id="kpi-parti">--</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card alert">
                    <div class="kpi-label">Pauvret√©</div>
                    <div class="kpi-value" style="color:var(--danger);" id="kpi-pauvrete">--</div>
                    <div class="kpi-sub">Zone Critique</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card warn">
                    <div class="kpi-label">Dette / Hab</div>
                    <div class="kpi-value" style="color:var(--warning);" id="kpi-dette">--</div>
                    <div class="kpi-sub">Point de vigilance</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card neutral">
                    <div class="kpi-label">Entreprises</div>
                    <div class="kpi-value h4 mb-0" id="kpi-eco">--</div>
                    <div class="kpi-sub">Tissu actif</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card warn">
                    <div class="kpi-label">S√©curit√©</div>
                    <div class="kpi-value h4 mb-0 text-warning">Moyen</div>
                    <div class="kpi-sub">Stable (2023)</div>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-pol">üèõÔ∏è POLITIQUE</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-soc">‚ù§Ô∏è SOCIAL & TERRITOIRE</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-hist">üìà ARCHIVES</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="tab-pol">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="kpi-card mb-4">
                            <h5 class="text-white mb-4">Guerre des Blocs (1983 - 2020)</h5>
                            <div class="chart-container"><canvas id="macroChart"></canvas></div>
                        </div>
                        <div class="kpi-card">
                            <h5 class="text-white mb-3">Benchmark Historique des Maires</h5>
                            <div class="table-responsive">
                                <table class="table table-dark-custom mb-0">
                                    <thead><tr><th>P√©riode</th><th>Maire</th><th>Parti</th><th>Dette Fin</th><th>Style</th></tr></thead>
                                    <tbody id="bench-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="kpi-card h-100">
                            <h5 class="text-white mb-3">Zoom √âlectoral</h5>
                            <select class="form-select bg-dark text-white border-secondary mb-3" onchange="updateElec(this.value)">
                                <option value="2020">2020 - Victoire B√©dier</option>
                                <option value="2014">2014 - Victoire Virapoull√©</option>
                                <option value="2008">2008 - Victoire Fruteau</option>
                            </select>
                            <div class="chart-container" style="height:250px"><canvas id="elecChart"></canvas></div>
                            <div class="mt-4 p-3 rounded" style="background:rgba(255,255,255,0.05); border-left:3px solid var(--info);">
                                <small class="text-info text-uppercase fw-bold">Analyse</small>
                                <p class="text-sm m-0 mt-1 text-muted" id="elec-analyse">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-soc">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="kpi-card h-100">
                            <h5 class="text-white mb-4">Indicateurs de Pr√©carit√©</h5>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1 small text-muted"><span>Ch√¥mage Jeunes (15-24 ans)</span> <span class="fw-bold" style="color:var(--danger);" id="soc-chomage">--</span></div>
                                <div class="progress" style="height:8px; background:#0f172a;"><div class="progress-bar" style="width:48%; background:var(--danger);"></div></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1 small text-muted"><span>Illettrisme (JDC)</span> <span class="fw-bold" style="color:var(--warning);" id="soc-illettrisme">--</span></div>
                                <div class="progress" style="height:8px; background:#0f172a;"><div class="progress-bar" style="width:22%; background:var(--warning);"></div></div>
                            </div>

                            <hr class="border-secondary my-4">
                            
                            <div class="row text-center">
                                <div class="col-6 border-end border-secondary">
                                    <div class="h3 text-white mb-0" id="soc-caf">--</div>
                                    <small class="text-muted text-uppercase">Alloc. CAF</small>
                                </div>
                                <div class="col-6">
                                    <div class="h3 mb-0" style="color:var(--danger);" id="soc-rsa">--</div>
                                    <small class="text-muted text-uppercase">RSA</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="kpi-card mb-4">
                            <h5 class="text-white mb-3">Cartographie des Zones (QPV)</h5>
                            <div id="map"></div>
                        </div>
                        <div class="kpi-card">
                            <h5 class="text-white mb-3">Courbe de S√©curit√© (Faits Constat√©s)</h5>
                            <div class="chart-container" style="height:250px"><canvas id="secuChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-hist">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="kpi-card">
                            <h5 class="text-white mb-3">Trajectoire D√©mographique (1968-2022)</h5>
                            <div class="chart-container"><canvas id="demoChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="kpi-card">
                            <h5 class="text-white mb-3">Historique Dette</h5>
                            <div class="chart-container"><canvas id="detteChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIGURATION CHARTJS "PRO"
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'Inter', sans-serif";

        let globalData, elecChart;

        async function init() {
            try {
                // Gestion des donn√©es manquantes
                const r = await fetch('data.json');
                if(!r.ok) throw new Error("JSON Error");
                globalData = await r.json();

                // 1. KPI
                document.getElementById('last-update').innerText = globalData.meta.last_update;
                document.getElementById('kpi-pop').innerText = globalData.kpi.pop;
                document.getElementById('kpi-maire').innerText = globalData.kpi.maire.split(' ')[1];
                document.getElementById('kpi-parti').innerText = globalData.kpi.parti;
                document.getElementById('kpi-pauvrete').innerText = globalData.kpi.pauvrete;
                document.getElementById('kpi-dette').innerText = globalData.kpi.dette;
                document.getElementById('kpi-eco').innerText = globalData.kpi.entreprises;

                // 2. SOCIAL
                document.getElementById('soc-chomage').innerText = globalData.social.chomage;
                document.getElementById('soc-illettrisme').innerText = globalData.social.illettrisme;
                document.getElementById('soc-caf').innerText = globalData.social.caf;
                document.getElementById('soc-rsa').innerText = globalData.social.rsa;

                // 3. TABLEAU BENCHMARK (Avec couleurs correctes)
                const tb = document.getElementById('bench-body');
                tb.innerHTML = '';
                globalData.benchmark.forEach(b => {
                    tb.innerHTML += `
                        <tr>
                            <td class="text-white fw-bold">${b.periode}</td>
                            <td style="color:${b.color}">${b.maire}</td>
                            <td><span class="badge-style" style="background:${b.color}20; color:${b.color}; border:1px solid ${b.color}">${b.parti}</span></td>
                            <td class="text-warning font-monospace">${b.dette}</td>
                            <td class="text-muted small">${b.style}</td>
                        </tr>`;
                });

                // 4. CHART MACRO (Courbes liss√©es et remplies)
                new Chart(document.getElementById('macroChart'), {
                    type: 'line',
                    data: {
                        labels: globalData.charts.politique_macro.annees,
                        datasets: [
                            { label: 'Bloc Droite', data: globalData.charts.politique_macro.droite, borderColor: '#3b82f6', tension: 0.4, borderWidth: 3 },
                            { label: 'Bloc Gauche', data: globalData.charts.politique_macro.gauche, borderColor: '#e11d48', tension: 0.4, borderWidth: 3 }
                        ]
                    },
                    options: { maintainAspectRatio: false, scales: { y: { min: 30 } }, plugins: { legend: { labels: { color: '#e2e8f0' } } } }
                });

                // 5. CHART SECU (Couleur Visible + D√©grad√©)
                const ctxSecu = document.getElementById('secuChart').getContext('2d');
                const gradientSecu = ctxSecu.createLinearGradient(0, 0, 0, 400);
                gradientSecu.addColorStop(0, '#3b82f6'); // Bleu vif en haut
                gradientSecu.addColorStop(1, '#0f172a'); // Fonc√© en bas

                new Chart(ctxSecu, {
                    type: 'bar',
                    data: {
                        labels: globalData.charts.securite.annees,
                        datasets: [{ 
                            label: 'Faits Constat√©s', 
                            data: globalData.charts.securite.data, 
                            backgroundColor: gradientSecu,
                            borderRadius: 4,
                            borderWidth: 0
                        }]
                    },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: false, min: 1500 } } }
                });

                // 6. CHART DEMO (Area Chart)
                const ctxDemo = document.getElementById('demoChart').getContext('2d');
                const gradientDemo = ctxDemo.createLinearGradient(0, 0, 0, 400);
                gradientDemo.addColorStop(0, 'rgba(56, 189, 248, 0.5)'); 
                gradientDemo.addColorStop(1, 'rgba(56, 189, 248, 0)');

                new Chart(ctxDemo, {
                    type: 'line',
                    data: {
                        labels: globalData.charts.demographie.annees,
                        datasets: [{ 
                            label: 'Population', 
                            data: globalData.charts.demographie.data, 
                            borderColor: '#38bdf8', 
                            backgroundColor: gradientDemo, 
                            fill: true,
                            tension: 0.4 
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });

                // 7. CHART DETTE
                new Chart(document.getElementById('detteChart'), {
                    type: 'bar',
                    data: {
                        labels: globalData.charts.dette.annees,
                        datasets: [{ label: 'Dette ‚Ç¨', data: globalData.charts.dette.data, backgroundColor: '#f59e0b', borderRadius: 4 }]
                    },
                    options: { maintainAspectRatio: false }
                });

                // 8. ELEC DETAIL
                const ctxE = document.getElementById('elecChart');
                elecChart = new Chart(ctxE, { 
                    type: 'doughnut', 
                    data: { labels:[], datasets:[{data:[]}] }, 
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{color:'white'} } }, cutout: '70%' } 
                });
                updateElec('2020');

                // 9. MAP
                const map = L.map('map', {zoomControl: false}).setView([-20.9606, 55.6495], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '¬© CartoDB'}).addTo(map);
                L.circleMarker([-20.942, 55.665], {color: '#ef4444', radius: 8}).addTo(map).bindPopup("<b>Fayard</b><br>Tension √âlev√©e");
                L.circleMarker([-20.950, 55.635], {color: '#f59e0b', radius: 8}).addTo(map).bindPopup("<b>Cambuston</b><br>Zone Pivot");
                L.circleMarker([-20.9606, 55.6495], {color: '#3b82f6', radius: 6}).addTo(map).bindPopup("<b>Mairie</b>");

            } catch (e) { console.error(e); }
        }

        function updateElec(year) {
            const d = globalData.charts.elections[year];
            elecChart.data.labels = d.labels;
            elecChart.data.datasets[0].data = d.data;
            elecChart.data.datasets[0].backgroundColor = d.colors;
            elecChart.data.datasets[0].borderWidth = 0;
            elecChart.update();
            document.getElementById('elec-analyse').innerHTML = d.analyse;
        }

        init();
    </script>
</body>
</html>
